- name: "major"
  public: true
  plan:
    - get: "version-dev"
    - aggregate:
        - get: "version"
          params:
            bump: "major"
        - get: "repo"
          resource: "repo-dev"
        - task: "src"
          config:
            platform: linux
            image: docker:///konne/ubuntu-wget
            inputs: [ { name: "version-dev" } ]
            run:
              path: "/bin/bash"
              args: [ "-c", "wget -O- https://{{artifact-bucket}}.s3.amazonaws.com/{{artifact-dev-prefix}}src/logsearch-src-$( cat version-dev/number ).tgz | tar -xzf- --strip-components=1" ]
        - task: "release"
          config:
            platform: linux
            image: docker:///konne/ubuntu-wget
            inputs: [ { name: "version-dev" } ]
            run:
              path: "/bin/bash"
              args: [ "-c", "wget -O tarball.tgz https://{{artifact-bucket}}.s3.amazonaws.com/{{artifact-dev-prefix}}tarball/logsearch-$( cat version-dev/number ).tgz" ]
    - task: "finalize-release"
      file: "src/ci/tasks/finalize-release/task.yml"
      config:
        params:
          AWS_ACCESS_KEY: "{{ aws-access-key }}"
          AWS_SECRET_KEY: "{{ aws-secret-key }}"
    - put: "release-release"
      params:
        from: "create-release/repo/repo/releases/logsearch/(.+).tgz"
        to: "{{artifact-release-prefix}}tarball/"
    - put: "release-release-src"
      params:
        from: "create-release/repo/repo/releases-src/logsearch/(.+).tgz"
        to: "{{artifact-release-prefix}}src/"
    - put: "repo-release"
      params:
        repository: "create-release/repo/repo"
        rebase: true
        tag: "create-release/repo/name"
    - put: "github-release"
      params:
        name: "create-release/repo/name"
        tag: "create-release/repo/name"
        body: "create-release/repo/notes.md"
        commitish: "create-release/repo/commit"
    - put: "version"
      params:
        file: "version/number"
