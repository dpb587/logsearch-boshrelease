#!/bin/bash

set -e
set -u

function varsfrom {
  [ -e ci/config/$1.yml ] && echo "--vars-from ci/config/$1.yml"
  [ -e ci/config/$1-private.yml ] && echo "--vars-from ci/config/$1-private.yml"
}

function varslookup {
  cat ci/config/common.yml $( [ -e ci/config/common-private.yml ] && echo ci/config/common-private.yml ) \
    | grep "^$1:" \
    | tail -n1 \
    | awk '{ print $2 }' \
    | sed -E 's/"(.+)"/\1/'
}

export PR_BASE_REPO_OWNER=$( varslookup github-user )
export PR_BASE_REPO_NAME=$( varslookup github-repository )

# @todo remove me
export PR_BASE_REPO_OWNER=logsearch

YML=$( mktemp pipeline-XXXXXX )

#
# develop branch
#

./ci/pipelines/dev/generate > $YML

fly -t "${FLY_TARGET}" \
  configure --config $YML \
  $( varsfrom common ) \
  $( varsfrom develop ) \
  --var repo-resource=repo-dev \
  --var release-resource=release-dev \
  "${1:-logsearch}-develop"

#
# release
#
#
# ./ci/pipelines/release/generate > $YML
#
# fly -t "${FLY_TARGET}" \
#   configure --config $YML \
#   $( varsfrom common ) \
#   $( varsfrom develop ) \
#   $( varsfrom release ) \
#   "${1:-logsearch}-release"
#
# #
# # dynamic prs
# #
#
# if [ -f ci/config/pr.txt ] ; then
#   while read -r PR_NUMBER ; do
#     ./ci/pipelines/pr/generate $PR_NUMBER > $YML
#
#     echo "y" | fly -t "${FLY_TARGET}" \
#       configure --config $YML \
#       $( varsfrom common ) \
#       $( varsfrom develop ) \
#       $( varsfrom pr ) \
#       $( varsfrom pr/$PR_NUMBER ) \
#       --var repo-resource=repo-pr \
#       --var release-resource=release-pr \
#       "${1:-logsearch}-pr${PR_NUMBER}"
#   done < ci/config/pr.txt
# fi
#
# #
# # cleanup
# #

rm $YML
