#!/bin/bash

set -e
set -u

export PR_REPO_OWNER="${PR_REPO_OWNER:-logsearch}"
export PR_REPO_NAME="${PR_REPO_NAME:-logsearch-boshrelease}"

function varsfrom {
  [ -e ci/config/$1.yml ] && echo "--vars-from ci/config/$1.yml"
  [ -e ci/config/$1-private.yml ] && echo "--vars-from ci/config/$1-private.yml"
}

YML=$( mktemp pipeline-XXXXXX )

#
# develop branch
#

./ci/pipelines/dev/generate > $YML

fly -t "${FLY_TARGET}" \
  configure --config $YML \
  $( varsfrom common ) \
  $( varsfrom develop ) \
  --var repo-resource=repo-dev \
  --var release-resource=release-dev \
  "${1:-logsearch}-develop"

#
# dynamic prs
#

if [ -f ci/config/pr.txt ] ; then
  while read -r PR_NUMBER ; do
    ./ci/pipelines/pr/generate $PR_NUMBER > $YML
    
    echo "y" | fly -t "${FLY_TARGET}" \
      configure --config $YML \
      $( varsfrom common ) \
      $( varsfrom develop ) \
      $( varsfrom pr ) \
      $( varsfrom pr/$PR_NUMBER ) \
      --var repo-resource=repo-pr \
      --var release-resource=release-pr \
      "${1:-logsearch}-pr${PR_NUMBER}"
  done < ci/config/pr.txt
fi

#
# cleanup
#

rm $YML
